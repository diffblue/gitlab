import { GlLink } from '@gitlab/ui';
import VulnerabilityReportHeader from 'ee/security_dashboard/components/shared/vulnerability_report/vulnerability_report_header.vue';
import { mountExtended } from 'helpers/vue_test_utils_helper';
import CsvExportButton from 'ee/security_dashboard/components/shared/csv_export_button.vue';

describe('Vulnerability report header component', () => {
  let wrapper;

  const createWrapper = ({ provide } = {}) => {
    wrapper = mountExtended(VulnerabilityReportHeader, {
      provide,
      stubs: { CsvExportButton: true, GlButton: true },
    });
  };

  afterEach(() => {
    wrapper.destroy();
  });

  it('shows the submit vulnerability button when new vulnerability path is defined', () => {
    createWrapper({
      provide: {
        canAdminVulnerability: true,
        newVulnerabilityPath: '/vulnerabilities/new',
        glFeatures: { newVulnerabilityForm: true },
      },
    });

    expect(wrapper.findByText('Submit vulnerability').attributes('href')).toBe(
      '/vulnerabilities/new',
    );
  });

  it('does not show the submit vulnerability button when new vulnerability path is not defined', () => {
    createWrapper({
      provide: {
        canAdminVulnerability: true,
        glFeatures: { newVulnerabilityForm: true },
      },
    });

    expect(wrapper.findByText('Submit vulnerability').exists()).toBe(false);
  });

  it('does not should the submit vulnerability button when user cannot admin vulnerabilities', () => {
    createWrapper({
      provide: {
        canAdminVulnerability: false,
        newVulnerabilityPath: '/vulnerabilities/new',
        glFeatures: { newVulnerabilityForm: true },
      },
    });

    expect(wrapper.findByText('Submit vulnerability').exists()).toBe(false);
  });

  it('does not show the submit vulnerability button when the feature flag is not enabled', () => {
    createWrapper({
      provide: {
        canAdminVulnerability: true,
        newVulnerabilityPath: '/vulnerabilities/new',
      },
    });

    expect(wrapper.findByText('Submit vulnerability').exists()).toBe(false);
  });

  it('shows the CSV export button', () => {
    createWrapper();

    expect(wrapper.findComponent(CsvExportButton).exists()).toBe(true);
  });

  it('shows the correct link for the documentation', () => {
    const dashboardDocumentation = 'http://some/link';
    createWrapper({ provide: { dashboardDocumentation } });

    expect(wrapper.findComponent(GlLink).attributes('href')).toBe(dashboardDocumentation);
  });
});
