import { GlTabs } from '@gitlab/ui';
import Vue, { nextTick } from 'vue';
import VueRouter from 'vue-router';
import { shallowMount } from '@vue/test-utils';
import VulnerabilityReportTabs from 'ee/security_dashboard/components/shared/vulnerability_report/vulnerability_report_tabs.vue';
import VulnerabilityReportTab from 'ee/security_dashboard/components/shared/vulnerability_report/vulnerability_report_tab.vue';
import SurveyRequestBanner from 'ee/security_dashboard/components/shared/survey_request_banner.vue';
import projectVulnerabilitiesQuery from 'ee/security_dashboard/graphql/queries/project_vulnerabilities.query.graphql';
import { REPORT_TAB } from 'ee/security_dashboard/components/shared/vulnerability_report/constants';

Vue.use(VueRouter);
const router = new VueRouter();

describe('Vulnerability report tabs component', () => {
  let wrapper;

  const createWrapper = ({ slots } = {}) => {
    wrapper = shallowMount(VulnerabilityReportTabs, {
      router,
      propsData: {
        query: projectVulnerabilitiesQuery,
      },
      stubs: {
        VulnerabilityReportTab,
      },
      slots,
    });
  };

  const findTabsComponent = () => wrapper.findComponent(GlTabs);
  const findAllReportTabs = () => wrapper.findAllComponents(VulnerabilityReportTab);
  const findDevelopmentTab = () => findAllReportTabs().at(0);
  const findOperationalTab = () => findAllReportTabs().at(1);

  afterEach(() => {
    wrapper.destroy();
  });

  describe('survey request banner', () => {
    it('shows the survey request banner', () => {
      createWrapper();

      expect(wrapper.findComponent(SurveyRequestBanner).exists()).toBe(true);
    });
  });

  describe('tabs root component', () => {
    it.each`
      queryParam                | tabIndex
      ${undefined}              | ${0}
      ${REPORT_TAB.OPERATIONAL} | ${1}
    `(
      'shows tab with tabIndex $tabIndex when querystring is "$queryParam"',
      ({ queryParam, tabIndex }) => {
        router.replace({ query: { tab: queryParam } });
        createWrapper();

        expect(findTabsComponent().props('value')).toBe(tabIndex);
        expect(findDevelopmentTab().props('isActive')).toBe(tabIndex === 0);
        expect(findOperationalTab().props('isActive')).toBe(tabIndex === 1);
      },
    );

    it.each`
      tabIndex | queryParam
      ${0}     | ${undefined}
      ${1}     | ${REPORT_TAB.OPERATIONAL}
    `(
      'changes the tab when tabIndex $tabIndex is clicked and sets querystring to "$queryParam"',
      async ({ tabIndex, queryParam }) => {
        createWrapper();
        findTabsComponent().vm.$emit('input', tabIndex);
        await nextTick();

        expect(findTabsComponent().props('value')).toBe(tabIndex);
        expect(router.currentRoute.query.tab).toBe(queryParam);
      },
    );
  });

  describe('vulnerability report tabs', () => {
    it('shows 2 tabs', () => {
      createWrapper();
      expect(findAllReportTabs()).toHaveLength(2);
    });

    it.each`
      findComponent         | type                      | title
      ${findDevelopmentTab} | ${REPORT_TAB.DEVELOPMENT} | ${'developmentTab'}
      ${findOperationalTab} | ${REPORT_TAB.OPERATIONAL} | ${'operationalTab'}
    `('gets the expected props for the $type tab', ({ findComponent, type, title }) => {
      createWrapper();

      expect(findComponent().props()).toMatchObject({
        title: wrapper.vm.$options.i18n[title],
        type,
        query: projectVulnerabilitiesQuery,
      });
    });

    it('passes the slot content to the development tab', () => {
      createWrapper({
        slots: {
          'header-development': 'header slot content',
        },
      });

      expect(findDevelopmentTab().text()).toContain('header slot content');
    });

    it('shows the operational tab message in the operational tab', () => {
      createWrapper();

      expect(findOperationalTab().text()).toContain(wrapper.vm.$options.i18n.operationalTabMessage);
    });
  });
});
