<script>
import { PortalTarget } from 'portal-vue';
import { GlCollapsibleListbox, GlLink, GlIcon } from '@gitlab/ui';
import { VULNERABILITY_STATES } from 'ee/vulnerabilities/constants';
import { SEVERITY_LEVELS } from 'ee/security_dashboard/store/constants';
import { createAlert } from '~/alert';
import glFeatureFlagMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import countsQuery from 'ee/security_dashboard/graphql/queries/vulnerability_severities_count.query.graphql';
import SummaryHighlights from 'ee/vue_merge_request_widget/extensions/security_reports/summary_highlights.vue';
import { __, s__ } from '~/locale';
import { scrollToElement, contentTop } from '~/lib/utils/common_utils';
import VulnerabilityCounts from './vulnerability_counts.vue';
import VulnerabilityListGraphql from './vulnerability_list_graphql.vue';
import VulnerabilityFilters from './vulnerability_filters.vue';
import { FILTERS } from './constants';

const GROUP_STATUS = [
  { value: 'detected', text: VULNERABILITY_STATES.detected },
  { value: 'confirmed', text: VULNERABILITY_STATES.confirmed },
  { value: 'dismissed', text: VULNERABILITY_STATES.dismissed },
  { value: 'resolved', text: VULNERABILITY_STATES.resolved },
];

const GROUP_SEVERITY = [
  { value: 'critical', text: SEVERITY_LEVELS.critical },
  { value: 'high', text: SEVERITY_LEVELS.high },
  { value: 'medium', text: SEVERITY_LEVELS.medium },
  { value: 'low', text: SEVERITY_LEVELS.low },
  { value: 'unknown', text: SEVERITY_LEVELS.unknown },
  { value: 'info', text: SEVERITY_LEVELS.info },
];

export default {
  components: {
    VulnerabilityCounts,
    VulnerabilityListGraphql,
    VulnerabilityFilters,
    PortalTarget,
    SummaryHighlights,
    GlCollapsibleListbox,
    GlLink,
    GlIcon,
  },
  mixins: [glFeatureFlagMixin()],
  inject: {
    fullPath: {
      default: '',
    },
    isProjectVulnerabilityReport: {
      default: false,
    },
  },
  props: {
    filterDropdowns: {
      type: Array,
      required: true,
    },
    fields: {
      type: Array,
      required: true,
    },
    filterFn: {
      type: Function,
      required: false,
      default: (filters) => filters,
    },
    // Whether this report is visible on the page or not. Intended to be used with tabs so that if
    // the tab that the report is in is not active, the vulnerabilities aren't fetched.
    isVisible: {
      type: Boolean,
      required: false,
      default: true,
    },
    showCounts: {
      type: Boolean,
      required: false,
      default: false,
    },
  },
  data() {
    return {
      expandedGroup: '',
      groupBy: '',
      groupCounts: {},
      graphqlFilters: undefined,
    };
  },
  computed: {
    shouldShowProjectNamespace() {
      return this.filterDropdowns.includes(FILTERS.PROJECT);
    },
    shouldShowGroupByButton() {
      return this.glFeatures.vulnerabilityReportGrouping && this.isProjectVulnerabilityReport;
    },
    groups() {
      if (!this.groupBy) {
        return [{ value: '' }];
      }

      const groups = {
        state: GROUP_STATUS,
        severity: GROUP_SEVERITY,
      }[this.groupBy];

      const currentFiltersForGroup = [...(this.graphqlFilters?.[this.groupBy] || [])];

      // When a dismissal reason is selected, the state filter does not contain
      // `DISMISSED` as a value. This workaround adds the `DISMISSED` item to the
      // cloned array.
      if (this.groupBy === 'state' && this.graphqlFilters.dismissalReason?.length) {
        currentFiltersForGroup.push('DISMISSED');
      }

      return currentFiltersForGroup?.length
        ? groups.filter(({ value }) => currentFiltersForGroup.includes(value.toUpperCase()))
        : groups;
    },
    groupFilters() {
      if (!this.groupBy) {
        return {};
      }

      return this.formatGroupFilters(this.expandedGroup);
    },
  },
  watch: {
    groupBy(newValue) {
      if (!newValue) {
        this.expandedGroup = '';
      } else {
        this.loadCounts();
      }
    },
    graphqlFilters() {
      if (this.groupBy) {
        this.loadCounts();
      }
    },
  },
  methods: {
    formatGroupFilters(expandedGroup) {
      const isDismissedTab = expandedGroup === 'dismissed';
      const isStateGroup = this.groupBy === 'state';
      const hasDismissalReasons = this.graphqlFilters?.dismissalReason?.length > 0;
      const dismissalReason = this.graphqlFilters?.dismissalReason;

      // Special case:
      // state => DISMISSED means we're requesting all dismissed findings.
      // However, when dismissalReason is specified, we need to empty the `state`
      // and pass just dimissal reasons.
      if (isDismissedTab && hasDismissalReasons) {
        return { state: [], dismissalReason };
      }

      return {
        [this.groupBy]: [expandedGroup.toUpperCase()],
        // When a group other than `dismissed` is selected, since we want to display
        // only relevant findings to that group (e.g. detected), we need to empty the
        // dismissalReason array.
        dismissalReason: isStateGroup ? [] : dismissalReason,
      };
    },
    updateGraphqlFilters(graphqlFilters) {
      this.graphqlFilters = this.filterFn(graphqlFilters);
    },
    emitCountsChanged(counts) {
      this.$emit('counts-changed', counts);
    },
    scrollToTopOfList() {
      const { vulnerabilityListTop } = this.$refs;
      // Only scroll to the top of the vulnerability list if it's above and outside the main content
      // area (the space below the static page header).
      if (vulnerabilityListTop.getBoundingClientRect().top < contentTop()) {
        scrollToElement(vulnerabilityListTop);
      }
    },
    toggleExpandedGroup(value) {
      this.expandedGroup = this.expandedGroup === value ? '' : value;
    },
    loadCounts() {
      this.groups
        .filter(({ value }) => value)
        .forEach(({ value }) => {
          const queryName = `groupCounts.${value}`;
          const variables = {
            fullPath: this.fullPath,
            isProject: true,
            isGroup: false,
            isInstance: false,
            ...this.graphqlFilters,
            ...this.formatGroupFilters(value),
          };

          if (this.$apollo.queries[queryName]) {
            this.$apollo.queries[queryName].setVariables(variables);
            return;
          }

          this.$apollo.addSmartQuery(queryName, {
            query: countsQuery,
            errorPolicy: 'none',
            variables() {
              return variables;
            },
            update(data) {
              this.$set(this.groupCounts, value, data.project?.vulnerabilitySeveritiesCount);
              return data.project?.vulnerabilitySeveritiesCount;
            },
            error() {
              createAlert({
                message: s__(
                  'SecurityReports|Error fetching the vulnerability counts. Please check your network connection and try again.',
                ),
              });
            },
          });
        });
    },
  },
  portalName: 'vulnerability-report-sticky',
  groupByOptions: [
    { value: '', text: __('None') },
    { value: 'state', text: __('Status') },
    { value: 'severity', text: __('Severity') },
  ],
};
</script>

<template>
  <div>
    <vulnerability-counts
      v-if="showCounts"
      class="gl-mb-7"
      :filters="graphqlFilters"
      @counts-changed="emitCountsChanged"
    />

    <div ref="vulnerabilityListTop" data-testid="vulnerability-list-top"></div>

    <div class="security-dashboard-filters gl-bg-white">
      <vulnerability-filters :filters="filterDropdowns" @filters-changed="updateGraphqlFilters" />
      <div
        v-if="shouldShowGroupByButton"
        class="gl-display-flex gl-align-items-center gl-p-5 gl-bg-gray-10 gl-border-b-1 gl-border-b-solid gl-border-b-gray-100"
      >
        <label for="group-by" class="gl-m-0">{{ __('Group by:') }}</label>
        <gl-collapsible-listbox
          id="group-by"
          v-model="groupBy"
          category="tertiary"
          class="gl-ml-2"
          :items="$options.groupByOptions"
        />
      </div>
      <portal-target v-if="isVisible" :name="$options.portalName" />
    </div>

    <template v-if="isVisible">
      <div v-for="group in groups" :key="group.value">
        <div
          v-if="group.text"
          class="gl-p-5 gl-bg-gray-10 gl-border-b-1 gl-border-b-solid gl-border-b-gray-100 gl-display-flex gl-align-center"
          :data-testid="`vulnerability-list-group-header-${group.value}`"
        >
          <gl-icon
            name="chevron-right"
            class="gl-mr-2 gl-transition-medium"
            :class="{ 'gl-rotate-90': expandedGroup === group.value }"
          />
          <gl-link
            href="#"
            class="gl-text-body"
            :data-testid="`vulnerability-list-group-link-${group.value}`"
            @click="toggleExpandedGroup(group.value)"
            ><strong>{{ group.text }}</strong></gl-link
          >
          <summary-highlights
            v-if="groupCounts[group.value]"
            :data-testid="`summary-highlights-${group.value}`"
            class="gl-ml-3"
            :highlights="groupCounts[group.value]"
          />
        </div>
        <vulnerability-list-graphql
          v-if="expandedGroup === group.value"
          :class="{ 'has-group-by': shouldShowGroupByButton, 'gl-mb-6': Boolean(groupBy) }"
          :fields="fields"
          :filters="graphqlFilters"
          :group-filters="groupFilters"
          :show-project-namespace="shouldShowProjectNamespace"
          :portal-name="$options.portalName"
          @vulnerability-clicked="$emit('vulnerability-clicked', $event)"
          @query-variables-changed="scrollToTopOfList"
        />
      </div>
    </template>
  </div>
</template>
