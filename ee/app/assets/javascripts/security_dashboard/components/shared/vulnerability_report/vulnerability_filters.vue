<script>
import { debounce, cloneDeep, isEqual } from 'lodash';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import ActivityFilter from '../filters/activity_filter.vue';
import ProjectFilter from '../filters/project_filter.vue';
import ScannerFilter from '../filters/scanner_filter.vue';
import SimpleFilter from '../filters/simple_filter.vue';
import ClusterFilter from '../filters/cluster_filter.vue';
import ToolFilter from '../filters/tool_filter.vue';
import { FILTERS, FILTER_NAME_TOOL } from './constants';

const { ACTIVITY, TOOL_VENDOR, PROJECT, CLUSTER } = FILTERS;

export default {
  components: {
    ToolFilter,
    SimpleFilter,
    ScannerFilter,
    ActivityFilter,
    ProjectFilter,
    ClusterFilter,
  },
  mixins: [glFeatureFlagsMixin()],
  props: {
    filters: {
      type: Array,
      required: true,
    },
  },
  data() {
    return {
      filterQuery: {},
      // When this component is first shown, every filter will emit its own @filter-changed event at
      // the same time, which will trigger this method multiple times. We'll debounce it so that it
      // only runs once. Note that this is in data() so that it's unique per instance. Otherwise,
      // every instance of this component will share the same debounce function.
      emitFilterChange: debounce(function emit() {
        this.$emit('filters-changed', this.filterQuery);
      }),
    };
  },
  methods: {
    getComponentType(filter) {
      if (this.glFeatures.refactorVulnerabilityToolFilter && filter.name === FILTER_NAME_TOOL) {
        return ToolFilter;
      }
      switch (filter) {
        case TOOL_VENDOR:
          return ScannerFilter;
        case ACTIVITY:
          return ActivityFilter;
        case PROJECT:
          return ProjectFilter;
        case CLUSTER:
          return ClusterFilter;
        default:
          return SimpleFilter;
      }
    },
    updateFilterQuery(query) {
      const oldQuery = cloneDeep(this.filterQuery);
      this.filterQuery = { ...this.filterQuery, ...query };
      // Don't emit if the filters didn't change because it will trigger the GraphQL queries to run.
      if (!isEqual(oldQuery, this.filterQuery)) {
        this.emitFilterChange();
      }
    },
  },
};
</script>

<template>
  <div
    class="vulnerability-report-filters gl-p-5 gl-bg-gray-10 gl-border-b-1 gl-border-b-solid gl-border-b-gray-100"
  >
    <component
      :is="getComponentType(filter)"
      v-for="filter in filters"
      :key="filter.id"
      :filter="filter"
      :data-testid="filter.id"
      @filter-changed="updateFilterQuery"
    />
  </div>
</template>
