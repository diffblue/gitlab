<script>
import { PortalTarget } from 'portal-vue';
import { helpPagePath } from '~/helpers/help_page_helper';
import VulnerabilityListGraphql from '../shared/vulnerability_report/vulnerability_list_graphql.vue';
import VulnerabilityFilters from '../shared/vulnerability_report/vulnerability_filters.vue';
import {
  FIELD_PRESETS,
  FILTER_PRESETS,
  REPORT_TAB,
  REPORT_TYPE_PRESETS,
} from '../shared/vulnerability_report/constants';
import projectVulnerabilitiesQuery from '../../graphql/queries/project_vulnerabilities.query.graphql';
import { DASHBOARD_TYPES } from '../../store/constants';

const PORTAL_NAME = 'vulnerability-report-sticky';

export default {
  components: {
    PortalTarget,
    VulnerabilityFilters,
    VulnerabilityListGraphql,
  },
  /**
   * Normally we should only use provide when bootstrapping an application, but this is an exception
   * because there is a CE/EE split in `app/assets/javascripts/clusters/agents/index.js` (where
   * these values are only needed for EE) and there is necessary rename/variable naming that only
   * makes sense in the context of being in the `app/assets/javascripts/security_dashboard`
   * directory.
   */
  provide() {
    return {
      dashboardDocumentation: helpPagePath('user/application_security/security_dashboard/index'),
      dashboardType: DASHBOARD_TYPES.PROJECT,
      fullPath: this.projectPath,
      canViewFalsePositive: false,
      hasJiraVulnerabilitiesIntegrationEnabled: false,
    };
  },
  inject: ['projectPath'],
  props: {
    clusterAgentId: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      graphqlFilters: { clusterAgentId: [this.clusterAgentId] },
    };
  },
  methods: {
    updateGraphqlFilters(graphqlFilters) {
      this.graphqlFilters = graphqlFilters;
      this.graphqlFilters.reportType = REPORT_TYPE_PRESETS.OPERATIONAL;
      this.graphqlFilters.clusterAgentId = [this.clusterAgentId];
    },
  },
  fieldsToShow: FIELD_PRESETS[REPORT_TAB.OPERATIONAL],
  filtersToShow: FILTER_PRESETS[REPORT_TAB.OPERATIONAL],
  REPORT_TAB,
  PORTAL_NAME,
  projectVulnerabilitiesQuery,
};
</script>

<template>
  <div>
    <div class="security-dashboard-filters gl-mt-7">
      <vulnerability-filters
        :filters="$options.filtersToShow"
        @filters-changed="updateGraphqlFilters"
      />
      <portal-target :name="$options.PORTAL_NAME" />
    </div>

    <vulnerability-list-graphql
      :query="$options.projectVulnerabilitiesQuery"
      :fields="$options.fieldsToShow"
      :filters="graphqlFilters"
      :portal-name="$options.PORTAL_NAME"
    />
  </div>
</template>
