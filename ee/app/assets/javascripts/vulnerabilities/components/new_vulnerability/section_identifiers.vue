<script>
import { GlFormGroup, GlFormInput, GlButton } from '@gitlab/ui';
import { s__ } from '~/locale';

export default {
  components: {
    GlFormGroup,
    GlFormInput,
    GlButton,
  },
  id: 0,
  data() {
    return {
      identifiers: [{ identifierCode: '', identifierUrl: '', id: this.$options.id }],
    };
  },
  methods: {
    emitChanges() {
      this.$emit('change', { identifiers: this.identifiers });
    },
    addIdentifier() {
      this.$options.id += 1;
      this.identifiers.push({ identifierCode: '', identifierUrl: '', id: this.$options.id });
    },
    removeIdentifier(id) {
      this.identifiers = this.identifiers.filter((i) => i.id !== id);
    },
  },
  i18n: {
    title: s__('Vulnerability|Identifiers'),
    description: s__(
      'Vulnerability|Enter the associated CVE or CWE entries for this vulnerability.',
    ),
    identifierCode: s__('Vulnerability|Identifier code'),
    identifierUrl: s__('Vulnerability|Identifier URL'),
    addIdentifier: s__('Vulnerability|Add another identifier'),
    removeIdentifierRow: s__('Vulnerability|Remove identifier row'),
  },
};
</script>

<template>
  <div>
    <header class="gl-pt-4 gl-my-6 gl-border-t-gray-100 gl-border-t-solid gl-border-t-1">
      <h3 class="gl-mt-0 gl-mb-3">
        {{ $options.i18n.title }}
      </h3>
      <p data-testid="section-description">
        {{ $options.i18n.description }}
      </p>
    </header>
    <div
      v-for="identifier in identifiers"
      :key="identifier.id"
      data-testid="identifier-row"
      class="gl-display-flex gl-mb-6"
    >
      <gl-form-group
        :label="$options.i18n.identifierCode"
        :label-for="`form-identifier-code-${identifier.id}`"
        class="gl-mr-6 gl-mb-0"
      >
        <gl-form-input
          :id="`form-identifier-code-${identifier.id}`"
          v-model="identifier.identifierCode"
          type="text"
          @change="emitChanges"
        />
      </gl-form-group>
      <gl-form-group
        :label="$options.i18n.identifierUrl"
        :label-for="`form-identifier-url-${identifier.id}`"
        class="gl-flex-grow-1 gl-mb-0"
      >
        <gl-form-input
          :id="`form-identifier-url-${identifier.id}`"
          v-model="identifier.identifierUrl"
          type="text"
          @change="emitChanges"
        />
      </gl-form-group>
      <gl-button
        v-if="identifier.id > 0"
        class="gl-align-self-end gl-ml-4 gl-shadow-none!"
        icon="remove"
        :aria-label="$options.i18n.removeIdentifierRow"
        @click="removeIdentifier(identifier.id)"
      />
      <!-- 
        The first row does not contain a remove button and this creates
        a misalignment. This button is here as a placeholder to align the rows,
        it's not visible to the user but it occupies the space hence aligns the 
        rows properly.
      -->
      <gl-button
        v-else
        class="gl-align-self-end gl-ml-4 gl-shadow-none gl-visibility-hidden"
        icon="remove"
      />
    </div>
    <gl-button
      data-testid="add-identifier-row"
      category="secondary"
      variant="confirm"
      @click="addIdentifier"
      >{{ $options.i18n.addIdentifier }}</gl-button
    >
  </div>
</template>
