<script>
import { GlLink, GlIcon, GlSkeletonLoader, GlSafeHtmlDirective } from '@gitlab/ui';
import * as Sentry from '@sentry/browser';
import { s__, __ } from '~/locale';
import securityTrainingProvidersQuery from '~/security_configuration/graphql/security_training_providers.query.graphql';
import securityTrainingVulnerabilityQuery from '~/security_configuration/graphql/security_training_vulnerability.query.graphql';
import glFeatureFlagsMixin from '~/vue_shared/mixins/gl_feature_flags_mixin';
import Tracking from '~/tracking';
import {
  TRACK_CLICK_TRAINING_LINK_ACTION,
  TRACK_TRAINING_LOADED_ACTION,
} from '~/security_configuration/constants';
import { TEMP_PROVIDER_LOGOS } from '~/security_configuration/components/constants';
import { SUPPORTED_IDENTIFIER_TYPES, SECURITY_TRAINING_URL_STATUS_COMPLETED } from '../constants';

export const i18n = {
  trainingDescription: s__(
    'Vulnerability|Learn more about this vulnerability and the best way to resolve it.',
  ),
  trainingUnavailable: s__('Vulnerability|Training not available for this vulnerability.'),
  viewTraining: s__('Vulnerability|View training'),
  loading: __('Loading'),
};

export default {
  i18n,
  TEMP_PROVIDER_LOGOS,
  components: {
    GlLink,
    GlIcon,
    GlSkeletonLoader,
  },
  directives: {
    SafeHtml: GlSafeHtmlDirective,
  },
  mixins: [glFeatureFlagsMixin(), Tracking.mixin()],
  props: {
    projectFullPath: {
      type: String,
      required: true,
    },
    identifiers: {
      type: Array,
      required: true,
    },
  },
  apollo: {
    securityTrainingProviders: {
      query: securityTrainingProvidersQuery,
      update({ project }) {
        return project?.securityTrainingProviders;
      },
      error(e) {
        Sentry.captureException(e);
      },
      variables() {
        return {
          fullPath: this.projectFullPath,
        };
      },
    },
    securityTrainingUrls: {
      query: securityTrainingVulnerabilityQuery,
      pollInterval: 5000,
      update({ project }) {
        if (!project) {
          return [];
        }
        const { securityTrainingUrls = [] } = project;

        const allUrlsAreReady = securityTrainingUrls.every(
          ({ status }) => status === SECURITY_TRAINING_URL_STATUS_COMPLETED,
        );

        if (allUrlsAreReady) {
          this.$apollo.queries.securityTrainingUrls.stopPolling();
          this.isUrlsLoading = false;
        }

        return securityTrainingUrls;
      },
      variables() {
        return {
          projectFullPath: this.projectFullPath,
          identifierExternalIds: this.supportedIdentifiersExternalIds,
        };
      },
      error(e) {
        Sentry.captureException(e);
      },
    },
  },
  data() {
    return {
      securityTrainingProviders: [],
      vulnerability: {},
      training: null,
      isUrlsLoading: true,
    };
  },
  computed: {
    showVulnerabilityTraining() {
      return Boolean(
        this.glFeatures.secureVulnerabilityTraining && this.hasSecurityTrainingProviders,
      );
    },
    showTrainingNotFound() {
      return !this.hasSupportedIdentifier || !this.hasSecurityTrainingUrls;
    },
    hasSecurityTrainingProviders() {
      return this.securityTrainingProviders?.some(({ isEnabled }) => isEnabled);
    },
    supportedIdentifiersExternalIds() {
      return this.identifiers.flatMap(({ externalType, externalId }) =>
        externalType?.toLowerCase() === SUPPORTED_IDENTIFIER_TYPES.cwe ? externalId : [],
      );
    },
    hasSupportedIdentifier() {
      return this.supportedIdentifiersExternalIds.length > 0;
    },
    hasSecurityTrainingUrls() {
      const hasSecurityTrainingUrls = this.securityTrainingUrls?.length > 0;

      if (hasSecurityTrainingUrls) {
        this.track(TRACK_TRAINING_LOADED_ACTION, {
          property: this.projectFullPath,
        });
      }

      return hasSecurityTrainingUrls;
    },
  },
  watch: {
    showVulnerabilityTraining: {
      immediate: true,
      handler(showVulnerabilityTraining) {
        this.$emit('show-vulnerability-training', showVulnerabilityTraining);
      },
    },
  },
  methods: {
    clickTrainingLink(name) {
      this.track(TRACK_CLICK_TRAINING_LINK_ACTION, {
        label: `vendor_${name}`,
        property: this.projectFullPath,
      });
    },
  },
};
</script>

<template>
  <div v-if="showVulnerabilityTraining">
    <slot name="header"></slot>
    <p class="gl-text-gray-600!" data-testid="description">
      {{ $options.i18n.trainingDescription }}
    </p>
    <p v-if="showTrainingNotFound" data-testid="unavailable-message">
      {{ $options.i18n.trainingUnavailable }}
    </p>
    <div v-else-if="isUrlsLoading">
      <gl-skeleton-loader :width="200" :lines="3" />
    </div>
    <div v-else>
      <div v-for="({ name, url }, index) in securityTrainingUrls" :key="index" class="gl-mt-6">
        <div>
          <span v-if="$options.TEMP_PROVIDER_LOGOS[name]" class="gl-mr-1 gl-display-inline-flex">
            <div
              v-safe-html="$options.TEMP_PROVIDER_LOGOS[name].svg"
              data-testid="provider-logo"
              style="width: 12px"
              role="presentation"
            ></div>
          </span>
          <span class="gl-font-weight-bold gl-font-base">{{ name }}</span>
        </div>
        <gl-link :href="url" target="_blank" @click="clickTrainingLink(name)">
          {{ $options.i18n.viewTraining }}
          <gl-icon class="gl-ml-2" name="external-link" :size="12" />
        </gl-link>
      </div>
    </div>
  </div>
</template>
